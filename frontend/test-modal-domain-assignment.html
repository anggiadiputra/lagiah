<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Modal Domain Assignment</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <h1>Test Modal Domain Assignment</h1>
    <div id="output"></div>

    <script>
        const output = document.getElementById('output');
        
        function log(message) {
            output.innerHTML += '<p>' + message + '</p>';
            console.log(message);
        }
        
        async function testModalDomainAssignment() {
            try {
                log('=== Testing Modal Domain Assignment ===');
                
                const baseURL = 'http://localhost:3004/api/v1';
                const hostingId = 'cmdkjaau8002tmm3x5hswwulk';
                
                // 1. Login
                log('1. Logging in...');
                const loginResponse = await axios.post(`${baseURL}/auth/login`, {
                    email: 'admin@lagiah.com',
                    password: 'admin123'
                });
                
                const token = loginResponse.data.data.token;
                log('✅ Login successful');
                
                // 2. Get current hosting data
                log('2. Getting current hosting data...');
                const getResponse = await axios.get(`${baseURL}/hosting/${hostingId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                log('✅ GET successful');
                const hosting = getResponse.data.data;
                
                log(`Hosting: ${hosting.name} (${hosting.provider})`);
                log(`Current domains: ${hosting.domains.length}`);
                hosting.domains.forEach(d => {
                    log(`  - ${d.name} (Main: ${d.isMainDomain})`);
                });
                
                // 3. Simulate modal domain assignment (using domain API)
                log('3. Simulating modal domain assignment...');
                
                // First, remove all domains
                log('  Removing all domains...');
                for (const domain of hosting.domains) {
                    const removeData = {
                        hostingId: null,
                        vpsId: null,
                        isMainDomain: false,
                        domainHosting: null
                    };
                    
                    const removeResponse = await axios.put(`${baseURL}/domains/${domain.id}`, removeData, {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    log(`    Removed ${domain.name}`);
                }
                
                // 4. Assign domains one by one (simulating modal assignment)
                log('4. Assigning domains one by one...');
                const domainIds = ['cmdkgorvd001qmm3xix6hkmfw', 'cmdki6wia002bmm3xtio44o4y'];
                
                for (let i = 0; i < domainIds.length; i++) {
                    const domainId = domainIds[i];
                    const assignData = {
                        hostingId: hostingId,
                        vpsId: null,
                        domainHosting: `Hosting: ${hosting.provider}`
                        // Note: isMainDomain will be set by backend logic
                    };
                    
                    log(`  Assigning ${domainId} (index: ${i})...`);
                    
                    const assignResponse = await axios.put(`${baseURL}/domains/${domainId}`, assignData, {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    log(`    ✅ Assigned ${domainId}`);
                }
                
                // 5. Get updated hosting data
                log('5. Getting updated hosting data...');
                const updatedResponse = await axios.get(`${baseURL}/hosting/${hostingId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                log('✅ GET updated successful');
                const updatedHosting = updatedResponse.data.data;
                
                log(`Updated hosting: ${updatedHosting.name} (${updatedHosting.provider})`);
                log(`Updated domains: ${updatedHosting.domains.length}`);
                updatedHosting.domains.forEach(d => {
                    log(`  - ${d.name} (Main: ${d.isMainDomain})`);
                });
                
                // 6. Check main domain logic
                log('6. Checking main domain logic...');
                const mainDomains = updatedHosting.domains.filter(d => d.isMainDomain === true);
                log(`Domains with isMainDomain = true: ${mainDomains.length}`);
                
                if (mainDomains.length === 1) {
                    log('✅ Main domain logic is working correctly!');
                    log(`Main domain: ${mainDomains[0].name}`);
                } else if (mainDomains.length === 0) {
                    log('❌ No main domain found!');
                } else {
                    log('❌ Multiple main domains found!');
                    mainDomains.forEach(d => {
                        log(`  - ${d.name}`);
                    });
                }
                
                // 7. Compare with hosting API assignment
                log('7. Comparing with hosting API assignment...');
                
                // Reset domains
                log('  Resetting domains...');
                for (const domain of updatedHosting.domains) {
                    await axios.put(`${baseURL}/domains/${domain.id}`, {
                        hostingId: null,
                        vpsId: null,
                        isMainDomain: false,
                        domainHosting: null
                    }, {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                }
                
                // Use hosting API to assign domains
                log('  Using hosting API to assign domains...');
                const hostingUpdateData = {
                    name: hosting.name,
                    provider: hosting.provider,
                    status: hosting.status,
                    planName: hosting.planName,
                    cpanelUrl: hosting.cpanelUrl,
                    username: hosting.username,
                    password: "admin123",
                    expiresAt: hosting.expiresAt,
                    createdAt: hosting.createdAt,
                    domainIds: domainIds
                };
                
                const hostingUpdateResponse = await axios.put(`${baseURL}/hosting/${hostingId}`, hostingUpdateData, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                log('✅ Hosting API update successful');
                
                // Get final hosting data
                const finalResponse = await axios.get(`${baseURL}/hosting/${hostingId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const finalHosting = finalResponse.data.data;
                log(`Final hosting: ${finalHosting.name} (${finalHosting.provider})`);
                log(`Final domains: ${finalHosting.domains.length}`);
                finalHosting.domains.forEach(d => {
                    log(`  - ${d.name} (Main: ${d.isMainDomain})`);
                });
                
                const finalMainDomains = finalHosting.domains.filter(d => d.isMainDomain === true);
                log(`Final domains with isMainDomain = true: ${finalMainDomains.length}`);
                
                if (finalMainDomains.length === 1) {
                    log('✅ Hosting API main domain logic is working correctly!');
                } else {
                    log('❌ Hosting API main domain logic has issues!');
                }
                
            } catch (error) {
                log('❌ Error: ' + error.message);
                if (error.response) {
                    log('Status: ' + error.response.status);
                    log('Data: ' + JSON.stringify(error.response.data));
                }
            }
        }
        
        // Run test
        testModalDomainAssignment();
    </script>
</body>
</html> 