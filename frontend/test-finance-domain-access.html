<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Finance Domain Access</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 15px; margin: 5px; border: none; border-radius: 3px; cursor: pointer; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
    </style>
</head>
<body>
    <h1>Test Finance Domain Access</h1>
    
    <div class="test-section info">
        <h3>Instructions:</h3>
        <ol>
            <li><strong>IMPORTANT:</strong> Login ulang dengan user FINANCE: finance@lagiah.com / finance123</li>
            <li>Buka halaman Hosting Management</li>
            <li>Klik nama domain di kolom Domains</li>
            <li>Periksa apakah modal domain management terbuka</li>
            <li>Periksa apakah tombol "Add Selected Domains" muncul</li>
            <li>Jika masih tidak bisa, coba clear storage dan login ulang</li>
        </ol>
    </div>

    <div class="test-section info">
        <h3>Troubleshooting:</h3>
        <ul>
            <li><strong>Problem:</strong> User sudah login sebelum perubahan RBAC diterapkan</li>
            <li><strong>Solution:</strong> Login ulang untuk mendapatkan permissions yang baru</li>
            <li><strong>Alternative:</strong> Clear storage dan login ulang</li>
        </ul>
    </div>

    <div class="test-section">
        <h3>Current User Info:</h3>
        <div id="userInfo">Loading...</div>
    </div>

    <div class="test-section">
        <h3>RBAC Permissions:</h3>
        <div id="rbacInfo">Loading...</div>
    </div>

    <div class="test-section">
        <h3>Actions:</h3>
        <button class="btn-primary" onclick="checkUserInfo()">Check User Info</button>
        <button class="btn-secondary" onclick="clearStorage()">Clear Storage & Reload</button>
    </div>

    <script>
        function checkUserInfo() {
            const token = localStorage.getItem('auth_token');
            const userInfo = document.getElementById('userInfo');
            const rbacInfo = document.getElementById('rbacInfo');
            
            if (!token) {
                userInfo.innerHTML = '<span style="color: red;">No token found - Please login first</span>';
                rbacInfo.innerHTML = '<span style="color: red;">Cannot check RBAC without token</span>';
                return;
            }

            // Decode JWT token to get user info
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                userInfo.innerHTML = `
                    <strong>User ID:</strong> ${payload.id || 'N/A'}<br>
                    <strong>Email:</strong> ${payload.email || 'N/A'}<br>
                    <strong>Role:</strong> ${payload.role || 'N/A'}<br>
                    <strong>Name:</strong> ${payload.name || 'N/A'}<br>
                    <strong>Token Expires:</strong> ${new Date(payload.exp * 1000).toLocaleString()}
                `;

                // Check RBAC permissions based on role
                const role = payload.role;
                const isAdmin = role === 'ADMIN';
                const isStaff = role === 'STAFF' || role === 'ADMIN';
                const isFinance = role === 'FINANCE';
                const canCreateDomain = isAdmin || isStaff || isFinance;

                rbacInfo.innerHTML = `
                    <strong>Role:</strong> ${role}<br>
                    <strong>isAdmin:</strong> ${isAdmin}<br>
                    <strong>isStaff:</strong> ${isStaff}<br>
                    <strong>isFinance:</strong> ${isFinance}<br>
                    <strong>canCreateDomain:</strong> ${canCreateDomain}<br>
                    <strong>Can Access Domain Management:</strong> ${canCreateDomain ? '✅ YES' : '❌ NO'}
                `;

            } catch (error) {
                userInfo.innerHTML = '<span style="color: red;">Error decoding token: ' + error.message + '</span>';
                rbacInfo.innerHTML = '<span style="color: red;">Cannot check RBAC due to token error</span>';
            }
        }

        function clearStorage() {
            localStorage.clear();
            alert('Storage cleared. Please reload the page and login again.');
            location.reload();
        }

        // Auto-check on page load
        window.onload = function() {
            checkUserInfo();
        };
    </script>
</body>
</html> 